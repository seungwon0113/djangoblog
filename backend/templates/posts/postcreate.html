{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">게시글 작성</h3>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="isPublic" checked>
                        <label class="form-check-label" for="isPublic">
                            <i class="bi bi-unlock" id="lockIcon"></i>
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="is_public" id="isPublicHidden" value="true">
                        <div class="mb-3">
                            <label for="title" class="form-label">제목</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">내용</label>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="editButton">편집</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="previewButton">미리보기</button>
                            </div>
                            <div class="markdown-editor">
                                <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
                                <div id="preview" class="form-control d-none p-3" style="min-height: 250px; overflow-y: auto;"></div>
                            </div>
                            <div class="form-text">
                                마크다운 문법을 지원합니다. 코드 블록은 다음과 같이 작성하세요:<br>
                                <code>```python</code><br>
                                코드를 여기에 작성<br>
                                <code>```</code>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">카테고리</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" selected disabled>카테고리를 선택하세요</option>
                                {% for category in categories %}
                                <option value="{{ category.name }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">이미지</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="tags" class="form-label">태그</label>
                            <div class="tag-input-wrapper">
                                <input type="text" class="form-control" id="tagInput" placeholder="태그입력 후 스페이스바를 누르세요">
                                <div id="tagContainer" class="mt-2"></div>
                                <input type="hidden" name="tags" id="tagsHidden">
                            </div>
                            <div class="form-text">스페이스바를 누르면 태그가 추가됩니다.</div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-pencil-square"></i> 작성하기
                            </button>
                            <a href="{% url 'posts:post_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> 목록으로
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 코드 블록 스타일 */
.markdown-editor pre {
    background-color: #1e1e1e !important;  /* VS Code 스타일의 어두운 배경 */
    border-radius: 6px;
    padding: 16px;
    margin: 1em 0;
    overflow: auto;
}

.markdown-editor pre code {
    color: #d4d4d4 !important;  /* 밝은 색상의 텍스트 */
    background: none !important;
    border: none;
    padding: 0 !important;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre;
}

/* 인라인 코드 스타일 */
.markdown-editor code:not(pre code) {
    background-color: #2d2d2d;
    color: #d4d4d4;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 90%;
}

/* 미리보기 영역 스타일 */
#preview {
    background-color: white;
    padding: 20px !important;
}

.tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}
.tag-item {
    background-color: #e9ecef;
    border-radius: 15px;
    padding: 0.3rem 0.8rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}
.tag-remove {
    cursor: pointer;
    color: #666;
}
.tag-remove:hover {
    color: #dc3545;
}
</style>

<!-- marked.js 추가 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const contentTextarea = document.getElementById('content');
const preview = document.getElementById('preview');
const editButton = document.getElementById('editButton');
const previewButton = document.getElementById('previewButton');

// marked.js 설정
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true,
    langPrefix: 'hljs language-'
});

// 코드 블록 자동 완성
contentTextarea.addEventListener('input', (e) => {
    const pos = e.target.selectionStart;
    const content = e.target.value;
    
    // 백틱 3개를 입력했을 때
    // 처음에만 코드 블록 추가 하도록 수정
    if (content.slice(pos-3, pos) === '```') {
        // 이전 줄이 비어있거나 문서의 시작인 경우
        const afterText = content.slice(pos);
        if (!afterText || afterText.endsWith('\n')) {
            // 단순히 줄바꿈만 추가
            e.target.value = content + '\n\n```';
            // 커서를 중간으로 이동
            e.target.selectionStart = pos + 1;
            e.target.selectionEnd = pos + 1;
            e.preventDefault();
        }

    }
});

// 편집 모드
editButton.addEventListener('click', () => {
    preview.classList.add('d-none');
    contentTextarea.classList.remove('d-none');
    editButton.classList.add('active');
    previewButton.classList.remove('active');
});

// 미리보기 모드
previewButton.addEventListener('click', () => {
    preview.classList.remove('d-none');
    contentTextarea.classList.add('d-none');
    previewButton.classList.add('active');
    editButton.classList.remove('active');
    updatePreview();
});

// 미리보기 업데이트
function updatePreview() {
    const markdown = contentTextarea.value;
    preview.innerHTML = marked.parse(markdown);
    // 코드 하이라이트 적용
    preview.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
}

// 초기 상태 설정
editButton.classList.add('active');

document.addEventListener('DOMContentLoaded', function() {
    const tagInput = document.getElementById('tagInput');
    const tagContainer = document.getElementById('tagContainer');
    const tagsHidden = document.getElementById('tagsHidden');
    let tags = [];

    function updateTags() {
        // 태그 컨테이너 업데이트
        tagContainer.innerHTML = `
            <div class="tag-list">
                ${tags.map(tag => `
                    <span class="tag-item">
                        ${tag}
                        <i class="bi bi-x tag-remove" data-tag="${tag}"></i>
                    </span>
                `).join('')}
            </div>
        `;
        
        // hidden input 업데이트
        tagsHidden.value = tags.join(',');

        // 삭제 버튼에 이벤트 리스너 추가
        document.querySelectorAll('.tag-remove').forEach(btn => {
            btn.addEventListener('click', function() {
                const tagToRemove = this.dataset.tag;
                tags = tags.filter(tag => tag !== tagToRemove);
                updateTags();
            });
        });
    }

    tagInput.addEventListener('keyup', function(e) {
        if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            let tagText = this.value.trim();
            
            // # 없으면 추가
            if (!tagText.startsWith('#')) {
                tagText = '#' + tagText;
            }
            
            // 중복 체크 및 빈 태그 체크
            if (tagText !== '#' && !tags.includes(tagText)) {
                tags.push(tagText);
                updateTags();
                this.value = '';
            }
        }
    });

    // 폼 제출 전 태그 정리
    document.querySelector('form').addEventListener('submit', function(e) {
        // # 제거하고 저장 (모든 #을 제거한 후 저장)
        tagsHidden.value = tags.map(tag => tag.replace(/^#+/, '')).join(',');
    });
});

// 토글 변경 시 hidden input 값 업데이트
document.getElementById('isPublic').addEventListener('change', function() {
    const lockIcon = document.getElementById('lockIcon');
    const hiddenInput = document.getElementById('isPublicHidden');
    
    if (this.checked) {
        lockIcon.className = 'bi bi-unlock';
        hiddenInput.value = 'true';
    } else {
        lockIcon.className = 'bi bi-lock';
        hiddenInput.value = 'false';
    }
});
</script>
{% endblock %}